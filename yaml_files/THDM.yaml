##########################################################################
## GAMBIT configuration for running a diver scan of the THDM
## THDM Type III 
##
## Includes all compatible likelihoods:
## Theoretical, experimental & flavor
##
## Requires backends:
## THDMC, SuperIso, HiggsBounds, HiggsSignals
##########################################################################

Parameters:
    StandardModel_SLHA2: !import include/StandardModel_SLHA2_defaults.yaml

    THDM:
        lambda1: 
            fixed_value: 1
           # range: [-12.5664, 12.5664]
            #prior_type: flat
        lambda2: 
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        lambda3: 
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        lambda4: 
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        lambda5: 
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        lambda6: 
            fixed_value: 1
        lambda7:
            fixed_value: 1
        # -------------------------------------------
        m12_2:
            fixed_value: 250000 #This is 500**2
            #ranges: [-1e6, -1e4, 1e4, 1e6]
            #prior_type: double_log_flat_join
        tanb:
            fixed_value: 1
            #range: [0.1, 100]
            #prior_type: log
        yu2_re_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_22:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_23:
            fixed_value: 1
           # range: [-2.5, 2.5]
            #prior_type: flat
        yu2_re_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_32:
            #same_as: THDM::yu2_re_23 
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_re_33:
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_22:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_23:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_32:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yu2_im_33:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_22:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_23:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_32:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_re_33:
            fixed_value: 0.017
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_22:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_23:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_32:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yd2_im_33:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_22:
            fixed_value: 0.00043
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_23:
            fixed_value: 1
            #range: [-1.0, 1.0]
            #prior_type: flat
        yl2_re_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_32:
            #same_as: THDM::yl2_re_23
            fixed_value: 1
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_re_33:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_11:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_12:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_13:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_21:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_22:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_23:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_31:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_32:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
        yl2_im_33:
            fixed_value: 0
            #range: [-12.5664, 12.5664]
            #prior_type: flat
#
#
##############################
# Printer setup
##############################

Printer:

  # Select printer to use via string tag
  printer: cout
  #printer: hdf5

  options:
    # name of output file, which format should have when using cout?
    output_file: "THDM.hdf5"
    group: "/THDM"
    delete_file_on_restart: true

##############################
# Scanner setup
##############################

Scanner:

  use_scanner: random

  scanners:

    random:
      plugin: random
      like: LogLike
      point_number: 1 # This is just a test, may be 1000

    de:
      plugin: diver
      like: LogLike
      NP: 20000
      convthresh: 1e-5
      verbosity: 1

    random:
      plugin: random
      point_number: 10000
      like:  LogLike

      # No options to set, but still need the nodes at the moment...
      aux_printer_txt_options:
      aux_printer_stats_options:
      aux_printer_live_options:

ObsLikes:

    ###########################
    # Likelihoods
    ###########################

    # Checks that loop corrections to the pole mass of mh0
    # do not exceed 50% of the input mass at Qin
    # Likelihood type: Acceptance/Rejection
#    - purpose:    LogLike
#      capability: h0_loop_order_corrections
#      function: check_h0_loop_order_corrections

    # Checks that loop corrections to the pole masses of mH0,
    # mA0, mHpm do not exceed 50% of the input mass at Qin
    # Likelihood type: Acceptance/Rejection
#    - purpose:    LogLike
#      capability: THDM_scalar_loop_order_corrections
#      function: check_THDM_scalar_loop_order_corrections

    # Calculates all quartic Higgs couplings in the physical
    # basis & applies a 4pi perturbativity constraint on each
    # Likelihood type: Half-Gaussian
#    - purpose:    LogLike
#      capability: perturbativity_likelihood_THDM

    # Applies the THDM stability constraints on the potential
    # NOTE: This likelihood has two parts, described below
    # (i) Applies strict stability constraint
    # Likelihood type: Acceptance/Rejection
    # (ii) If rejected, applies looser stabililty constraints
    # Likelihood type: Half-Gaussian
#    - purpose:    LogLike
#      capability: stability_likelihood_THDM

    # Checks that the NLO scattering-matrix is unitary
    # Calculates and applies limit on eigenvalues of matrix
    # NOTE: This is always a subset of LO unitarity so it not needed
    # Likelihood type: Half-Gaussian
    # Only supports CP-conserving models
#    - purpose:    LogLike
#      capability: NLO_unitarity_likelihood_THDM

    # Calculates the electroweak precision parameters, S, T, U, V, W, X
    # & fits to meausured values. S, T, U involve a correlation matrix.
    # Includes low-energy notation described in arxiv::9407203.
    # Likelihood type: Half-Gaussian
#    - purpose:    LogLike
#      capability: oblique_parameters_likelihood_THDM

    # # -------------------------------------------
     
    #### NOTE
    # Flavor likelihoods imported from Superiso
    # Superiso is given SLHA struct filled with THDM input
    # & then likelihoods may be called as intended

    # B->s,gamma likelihood (Radiative B Decays)
    - capability: b2sgamma_LL
      function: b2sgamma_likelihood
      purpose: LogLike

    # B->s,l,l likelihood
    - capability: b2sll_LL
      function: b2sll_likelihood
      purpose: LogLike

    # B->l,l likelihood
    - capability: b2ll_LL
      function: b2ll_likelihood
      purpose: LogLike

    # Semi-Leptonic likelihood collection
#    - capability: SL_LL
#      function: SL_likelihood
#      purpose: LogLike

    # LUV likelihood collection
#    - purpose:    LogLike
#      capability: LUV_LL

    # Bs0 and Bd0 Meson Mass Splitting added to FlavBit
    # Necessary calculations added to superiso via patch supplied by Nazila
    - capability: deltaMB_LL
      function: deltaMB_likelihood
      purpose: LogLike

    - capability: deltaMBd_LL
      function: deltaMBd_likelihood
      purpose: LogLike
    
    # # B->Kstar,l,l likelihood [isospin asymmetry lowq2]
    - capability: b2sll_AI_LL
      function: BKstarmumu_AI_ll
      purpose: LogLike  

    # # B->Kstar,l,l likelihood [isospin asymmetry zero-crossing]
    - capability: b2sll_AI_zero_LL
      function: BKstarmumu_AI_zero_ll
      purpose: LogLike

    # # B->Kstar,l,l likelihood [branching]
    - capability: b2sll_BR_LL
      function: b2sll_BR_likelihood
      purpose: LogLike
    # -------------------------------------------

    ### NOTE
    # LHC & LEP likelihoods
    # Coupling Squared input structs are filled by colliderBit,
    # then chi^2 are extracted directly from HS & HB

    # HB 5beta likelihood
#    - capability: LEP_Higgs_LogLike
#      function: calc_HB_5_LEP_LogLike
#      purpose: LogLike
#      dependencies:
#        - capability: HB_ModelParameters_neutral
#          function: THDM_ModelParameters_effc
#          module: ColliderBit
#        - capability: HB_ModelParameters_charged
#          function: THDM_ModelParameters_charged
#          module: ColliderBit

    # HS 2beta likelihood
#    - capability: LHC_Higgs_LogLike
#      function: calc_HS_2_LHC_LogLike
#      purpose: LogLike
#      dependencies:
#        - capability: HB_ModelParameters_neutral
#          function: THDM_ModelParameters_effc
#          module: ColliderBit
#        - capability: HB_ModelParameters_charged
#          function: THDM_ModelParameters_charged
#          module: ColliderBit

    #################
    # Observables
    #################

    # Print spectrum as a map
    - capability: THDM_spectrum
      purpose: Observable
      type: map_str_dbl

    # -------------------------------------------

    # Checks if the vacuum leads to a global minimum solution
    # Returns 0 if it is metastable or unstable (otherwise 1)
    # Only supports CP-conserving models
#    - capability: vacuum_global_minimum
#      function: check_vacuum_global_minimum
#      purpose: Observable  
      

Rules:

    ##############################
    # Likelihood/Observable Rules
    ##############################

    ##
    # the check_all_scales option-flag triggers evaluation
    # of the likelihood at the default Qin scale, 
    # but also at QrunTo scale, where the worst performing
    # of the two likelihoods is returned.
    # eg. min[L(Q_in), L(Q_runTo)]
    #

    - capability: perturbativity_likelihood_THDM
      function: get_perturbativity_likelihood_THDM
      options:
        check_all_scales: true
        simple_perturbativity: false

    - capability: stability_likelihood_THDM
      function: get_stability_likelihood_THDM
      options:
        check_all_scales: true

    - capability: NLO_unitarity_likelihood_THDM
      function: get_NLO_unitarity_likelihood_THDM
      options:
        check_correction_ratio: true
    
    # -------------------------------------------

    # Specifies effc coupling input for HB/HS
    #- capability: HB_ModelParameters_neutral
     # function: THDM_ModelParameters_effc
      #module: ColliderBit

    #- capability: HB_ModelParameters_charged
     # function: THDM_ModelParameters_charged
      #module: ColliderBit

    - capability: all_BFs
      function: get_decaytable_as_map
      options:
        printall: true
      
    - capability: THDM_scalar_masses
      function: check_THDM_scalar_masses
      options:
        maximum_scalar_mass: 3000

    - capability: perturbativity_likelihood_THDM
      function: get_perturbativity_likelihood_THDM
      options:
        check_all_scales: true
        simple_perturbativity: false

    - capability: stability_likelihood_THDM
      function: get_stability_likelihood_THDM
      options:
        check_all_scales: true

    - capability: NLO_unitarity_likelihood_THDM
      function: get_NLO_unitarity_likelihood_THDM
      options:
        check_correction_ratio: true
        wave_function_corrections: true
        gauge_corrections: true
        yukawa_corrections: true

    - capability: Reference_SM_Higgs_decay_rates
      function: Ref_SM_Higgs_decays_THDM

    - capability: Reference_SM_other_Higgs_decay_rates
      function: Ref_SM_other_Higgs_decays_THDM

    - capability: Reference_SM_A0_decay_rates
      function: Ref_SM_A0_decays_THDM

    - capability: t_decay_rates
      function: t_decays_THDM

    - capability: HB_ModelParameters_neutral
      function: THDM_ModelParameters_effc
      module: ColliderBit

    - capability: HB_ModelParameters_charged
      function: THDM_ModelParameters_charged
      module: ColliderBit

    - capability: Higgs_Couplings
      function: THDM_higgs_couplings_2HDMC
      module: SpecBit

    - capability: SuperIso_modelinfo
      function: SI_fill
    
    - capability: bsgamma
      function: SI_bsgamma

    - capability: DeltaMs
      function: SI_Delta_MBs

    - capability: Bsmumu_untag
      function: SI_Bsmumu_untag
      module: FlavBit

  # -------------------------
  # OFF - b2mumu likelihoods

  # - capability: prediction_B2mumu
  #   options:
  #     obs_list: [BRuntag_Bsmumu, BR_Bdmumu]

  # - capability: B2mumu_LogLikelihood_.*
  #   function: HEPLike_B2mumu_LogLikelihood_LHCb
  #   options:
  #     obs_list: [BRuntag_Bsmumu, BR_Bdmumu]

  # -------------------------


  # -------------------------
  # OFF - b2kstar likelihoods

  # - capability: prediction_B2KstarmumuAng_.*_Atlas
  #   options:
  #     obs_list: [FL, S3, S4, S5, S7, S8]
  
  # - capability: B2KstarmumuAng_LogLikelihood_Atlas
  #   options:
  #     obs_list: [FL, S3, S4, S5, S7, S8]

  # - capability: prediction_B2KstarmumuAng_.*_Belle
  #   options:
  #     obs_list: [P4prime, P5prime]

  # - capability: B2KstarmumuAng_LogLikelihood_Belle
  #   options:
  #     obs_list: [P4prime, P5prime]

  # - capability: prediction_B2KstarmumuAng_.*_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]
  
  # - capability: B2KstarmumuAng_LogLikelihood_LHCb_2020
  #   function: HEPLike_B2KstarmumuAng_LogLikelihood_LHCb_2020
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]  

  # - capability: prediction_B2KstarmumuAng_.*_CMS
  #   options:
  #     obs_list: [P1, P5prime] 

  # - capability: B2KstarmumuAng_LogLikelihood_CMS
  #   options:
  #     obs_list: [P1, P5prime]

  # -------------------------


  # -------------------------
  # OFF - RK/RD star likelihoods

  # - capability: SuperIso_theory_covariance
  #   function: SI_theory_covariance

  # -------------------------


#########################
# Logging setup
#########################

Logger:

  redirection:
    [Debug] :  "debug.log"
    [Default] :  "default.log"
   # [DecayBit] :  "DecayBit.log"
   # [DarkBit] :  "DarkBit.log"
   # [PrecisionBit] :  "PrecisionBit.log"
   # [ColliderBit] :  "ColliderBit.log"
    [SpecBit] :  "SpecBit.log"
    [FlavBit] :  "FlavBit.log"
    [Dependency Resolver] :  "depresolver.log"
    [Scanner]:  "Scanner.log"

##########################
# Name/Value Section
##########################

KeyValues:

  likelihood:
    model_invalid_for_lnlike_below: -1e6
    model_invalid_for_lnlike_below_alt: -5e5
    debug: true

  default_output_path: "runs/THDM/"
  debug: false
