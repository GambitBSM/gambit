##########################################################################
## GAMBIT configuration for the following                               ##
##                                                                      ##
## Models: THDM, THDMI, THDMII, THDMLS, THDMflipped                     ##
##                                                                      ##
## Includes all compatible likelihoods:                                 ##
## theoretical, collider, electroweak, flavour                          ##
##                                                                      ##
## Requires backends:                                                   ##
## thdmc, SuperISO, HiggsBounds, HiggsSignals, HEPLike                  ##
##                                                                      ##
## Author: A.S. Woodcock                                                ##
## Date: 22/JUL/2022                                                    ##
##                                                                      ##
##########################################################################


Parameters:
    StandardModel_SLHA2: !import include/StandardModel_SLHA2_defaults.yaml

    THDMI:

      lambda1:
          range: [5, 13]
          prior_type: pow
          power: 6
          shift: -5
          output_scaled_values: false
          # scale: 0.01
      lambda2:
          range: [0, 13]
          prior_type: pow
          power: 6
          # scale: 0.01
      lambda3:
          range: [-13, 13]
          prior_type: flat
      lambda4:
          range: [-13, 13]
          prior_type: flat
      lambda5:
          range: [-13, 13]
          prior_type: flat
      lambda6:
          fixed_value: 0.0
      lambda7:
          fixed_value: 0.0
      m12_2:
          ranges: [-1e1, -1e0, 1e6, 1e10]
          prior_type: double_log_flat_join
      tanb:
          range: [0.03, 320]
          prior_type: flat


#################################
##     PRINTER SELECTION       ##
#################################


Printer:

  printer: cout

#################################
##     SCANNER SELECTION       ##
#################################


Scanner:

  use_scanner: random

  scanners:

    random:
      plugin: random
      point_number: 1
      like:  LogLike

#################################
##  OBSERVABLES / LIKELIHOODS  ##
#################################


ObsLikes:


  #-------------------------------------#
  #      COLLIDER LIKELIHOODS           #
  #-------------------------------------#

  # ### NOTE
  # # LHC & LEP likelihoods
  # # Coupling Squared input structs are filled by colliderBit,
  # # then chi^2 are extracted directly from HS & HB

  # # HiggsBounds 5.8.0 likelihood
  # - capability: LEP_Higgs_LogLike
  #   function: calc_HB_5_LEP_LogLike
  #   purpose: LogLike

  # # HiggsSignals 2.5.0 likelihood
  # - capability: LHC_Higgs_LogLike
  #   function: calc_HS_2_LHC_LogLike
  #   purpose: LogLike
  
  # Calculate the LHC likelihood
  - purpose:    LogLike
    capability: LHC_Combined_LogLike
  
  - purpose:    Observable
    capability: LHC_LogLike_per_analysis

  - purpose:    Observable
    capability: LHC_signals

  - purpose:    Observable
    capability: LHCEventLoopInfo


#################################
##          OBSERVABLES        ##
#################################

  # entire 2HDM spectrum
  - capability: THDM_spectrum
    type: map_str_dbl
    purpose: Observable

  # # 2HDM decay rates and branching ratios
  # - capability: all_BFs
  #   purpose: Observable




###################################
##  Likelihood/Observable Rules  ##
###################################


Rules:

  - capability: THDM_spectrum
    type: map_str_dbl
    options:
      print_minimal_yukawas: true

  - capability: THDM_spectrum
    type: Spectrum
    function: get_THDM_spectrum_tree #get_THDM_spectrum_FS
    
  - capability: couplingtable_THDM
    type: CouplingTable
    function: get_coupling_table_using_physical_basis

  - capability: decay_rates
    function: all_decays
    
  # Pass an SLHA2 spectrum to Pythia
  - capability: SpectrumAndDecaysForPythia
    function: getSpectrumAndDecaysForPythia_THDM
    options:
      slha_version: 2
      write_summary_to_log: false
      
  # Choose to where to get cross-sections from
  - capability: TotalCrossSection
    function: getEvGenCrossSection_as_base

  # Just use unweighted cross-sections
  - capability: EventWeighterFunction
    function: setEventWeight_unity

  # Choose where to get scattering events from
  - capability: HardScatteringEvent
    type: Pythia_default::Pythia8::Event
    function: generateEventPythia_THDM

  - capability: HardScatteringEvent
    type: HEPUtils::Event
    function: generateEventPythia_THDM_HEPUtils

  
  # Choose colliders to simulate and their convergence settings, and pick analyses to run with each collider.
  - capability: RunMC
    function: operateLHCLoop
    options:
      silenceLoop: false
      LHC_13TeV:
        min_nEvents: 10000
        max_nEvents: 50000
        events_between_convergence_checks: 5000
        target_fractional_uncert: 0.3
        halt_when_systematic_dominated: true
        all_analyses_must_converge: false
        all_SR_must_converge: false
        maxFailedEvents: 100
        analyses:
          - CMS_13TeV_1LEPbb_36invfb # TODO I just chose a random analysis for testing, probably doesnt have sensitivity to THDM
          - ATLAS_13TeV_4LEP_139invfb
          - ATLAS_13TeV_MONOJET_139infb
          - CMS_13TeV_MultiLEP_137invfb

  # Choose Monte Carlo event simulator and options.
  - capability:  HardScatteringSim
    type: Py8Collider_defaultversion
    function: getPythia_THDM
    options:
      LHC_13TeV:
        xsec_veto: 0.0001
        partonOnly: false
        jet_collections:
          antikt_R04:
            algorithm: antikt
            R: 0.4
            recombination_scheme: E_scheme
            strategy: Best
        jet_collection_taus: antikt_R04
        pythia_settings:
          - Beams:eCM = 13000
          - Next:numberShowProcess = 1
          - Print:quiet = off
          - Random:setSeed = on
          - PartonLevel:MPI = off
          - PartonLevel:ISR = on
          - PartonLevel:FSR = on
          - HadronLevel:all = on
          #- SUSY:all = off
          - Higgs:useBSM = on
          #- HiggsBSM:all = on # TODo Would want to specify exactly which processes we want turned on
          - HiggsBSM:qg2H1q = on
          - HiggsBSM:qg2H2q = on
          - HiggsBSM:gg2H1bbbar = on
          - HiggsBSM:qqbar2H1bbbar = on
          - HiggsBSM:gg2H2bbbar = on
          - HiggsBSM:qqbar2H2bbbar = on
          - HiggsBSM:qg2A3q = on
          - HiggsBSM:gg2A3bbbar = on
          - HiggsBSM:qqbar2A3bbbar = on
          - SLHA:minMassSM = 20 # TODO I am setting this lower than the default of 100 to see if this fixes Pythia ignoring the decay table for A0
          - Init:showChangedSettings = on
          - Init:showChangedParticleData = on
          - TauDecays:mode = 0
          - TimeShower:pTmin = 2
          #- SLHA:verbose = 3

  # Choose LHC likelihood form and options.
  - capability: LHC_LogLikes
    # Choose not to use the FullLikes backend.
    # function: calc_LHC_LogLikes
    # Choose to use the FullLikes backend when applicable
    function: calc_LHC_LogLikes_full
    backends:
    - {group: lnlike_marg_poisson, capability: lnlike_marg_poisson_lognormal_error}
    options:
      use_covariances: true
      use_marginalising: false
      combine_SRs_without_covariances: false
      nuisance_prof_initstep: 0.1
      nuisance_prof_convtol: 0.01
      nuisance_prof_maxsteps: 10000
      nuisance_prof_convacc: 0.01
      nuisance_prof_simplexsize: 1e-5
      nuisance_prof_method: 6
      nuisance_prof_verbosity: 0
      # covariance_marg_convthres_abs: 0.05
      # covariance_marg_convthres_rel: 0.05
      # covariance_nsamples_start: 1000000

  # Options for how the combined LHC loglike should be calculated
  - capability: LHC_Combined_LogLike
    options:
      write_summary_to_log: false
      cap_loglike: false
      cap_loglike_individual_analyses: false
      # skip_analyses:
  

  #- capability: all_BFs
  #  function: get_decaytable_as_map
  #  options:
  #    skip_particles: ['H-','W+','W-','Z0','e+_2','e+_3','e-_2','e-_3','mu+','mu-','pi+','pi-','pi0','tau+','tau-','tbar','u_3','ubar_3']
  #    print_BF_error: False
  #    print_as_widths: True

  - capability: Higgs_Couplings
    function: THDM_higgs_couplings_2HDMC

  - capability: Reference_SM_Higgs_decay_rates
    function: Ref_SM_Higgs_decays_THDM

  - capability: Reference_SM_other_Higgs_decay_rates
    function: Ref_SM_other_Higgs_decays_THDM

  - capability: Reference_SM_A0_decay_rates
    function: Ref_SM_A0_decays_THDM

  - capability: t_decay_rates
    function: t_decays_THDM


#########################
# Logging setup
#########################


Logger:

  redirection:
    [Debug] :  "debug.log"
    [Default] :  "default.log"
    [DecayBit] :  "DecayBit.log"
    [PrecisionBit] :  "PrecisionBit.log"
    [ColliderBit] :  "ColliderBit.log"
    [SpecBit] :  "SpecBit.log"
    [Dependency Resolver] :  "dep_resolver.log"
    [Scanner]:  "Scanner.log"


##########################
# Name/Value Section
##########################


KeyValues:

  print_scanID: false

  likelihood:
    print_invalid_points: false
    # model_invalid_for_lnlike_below: -1e6
    # model_invalid_for_lnlike_below_alt: -5e5
    # disable_print_for_lnlike_below: -4e4
    debug: false

  dependency_resolution:
    prefer_model_specific_functions: true
    use_old_routines: false

  exceptions:
    dependency_resolver_error: fatal
    dependency_resolver_warning: non-fatal
    core_warning: fatal

  default_output_path: "runs/THDM"
  debug: true
