##########################################################################
## GAMBIT configuration for running a diver scan of the THDM
## THDM Type II (with running)
##
## Includes all compatible likelihoods:
## Theoretical, experimental & flavor
##
## Requires backends:
## THDMC, SuperISO, HiggsBounds, HiggsSignals
##########################################################################

Parameters:
    StandardModel_SLHA2: !import ../include/StandardModel_SLHA2_defaults.yaml

    THDMIIatQ:
        lambda_1:
            range: [-12.5664, 12.5664]
            prior_type: flat
        lambda_2:
            range: [-12.5664, 12.5664]
            prior_type: flat
        lambda_3:
            range: [-12.5664, 12.5664]
            prior_type: flat
        lambda_4:
            range: [-12.5664, 12.5664]
            prior_type: flat
        lambda_5:
            range: [-12.5664, 12.5664]
            prior_type: flat
        # --- Assuming a CP-conserving THDM model ---
        lambda_6:
            fixed_value: 0.0
        lambda_7:
            fixed_value: 0.0
        # -------------------------------------------
        m12_2:
            ranges: [-1e6, -1e4, 1e4, 1e6]
            prior_type: double_log_flat_join
        tanb:
            range: [0.1, 100]
            prior_type: log
        Qin:
            fixed_value: 91.1876 # = mZ
        QrunTo:
            fixed_value: 1000 # for comparison with other literature

##############################
# Printer setup
##############################

Printer:

  # Select printer to use via string tag
  printer: hdf5

  options:
    # name of output file
    output_file: "GAMBIT_THDMIIatQ_scan_output_nlo_unitarity_with_corrections.hdf5"
    group: "/data"
    delete_file_on_restart: true


##############################
# Scanner setup
##############################

Scanner:
  use_scanner: de

  scanners:
    de:
      plugin: diver
      like: LogLike
      NP: 2500
      convthresh: 1e-5
      verbosity: 1

      # No options to set, but still need the nodes at the moment...
      aux_printer_txt_options:
      aux_printer_stats_options:
      aux_printer_live_options:

ObsLikes:

    - purpose:    LogLike
      capability: NLO_unitarity_likelihood_THDM

    #################
    # Observables
    #################

    # Physical basis observables

    - capability: mh0_pole
      function: obs_mh0_pole
      purpose: Observable

    - capability: mh0_running
      function: obs_mh0_running
      purpose: Observable

    - capability: mH0_pole
      function: obs_mH0_pole
      purpose: Observable

    - capability: mH0_running
      function: obs_mH0_running
      purpose: Observable

    - capability: mA0_pole
      function: obs_mA0_pole
      purpose: Observable

    - capability: mA0_running
      function: obs_mA0_running
      purpose: Observable

    - capability: mHpm_pole
      function: obs_mHpm_pole
      purpose: Observable

    - capability: mHpm_running
      function: obs_mHpm_running
      purpose: Observable

    # Generic basis observables

    - capability: lambda_1
      function: obs_lambda_1
      purpose: Observable

    - capability: lambda_2
      function: obs_lambda_2
      purpose: Observable

    - capability: lambda_3
      function: obs_lambda_3
      purpose: Observable

    - capability: lambda_4
      function: obs_lambda_4
      purpose: Observable

    - capability: lambda_5
      function: obs_lambda_5
      purpose: Observable

    - capability: lambda_6
      function: obs_lambda_6
      purpose: Observable

    - capability: lambda_7
      function: obs_lambda_7
      purpose: Observable

    - capability: m12_2
      function: obs_m12_2
      purpose: Observable

    - capability: m11_2
      function: obs_m11_2
      purpose: Observable

    - capability: m22_2
      function: obs_m22_2
      purpose: Observable

    # Mixing angles

    - capability: tanb
      function: obs_tanb
      purpose: Observable

    - capability: alpha
      function: obs_alpha
      purpose: Observable

    - capability: sba
      function: obs_sba
      purpose: Observable

    - capability: cba
      function: obs_cba
      purpose: Observable
  
    # -------------------------------------------

    # Checks if the vacuum leads to a global minimum solution
    # Returns 0 if it is metastable or unstable (otherwise 1)
    # Only supports CP-conserving models
    - capability: vacuum_global_minimum
      function: check_vacuum_global_minimum
      purpose: Observable
      

Rules:

    ##############################
    # Likelihood/Observable Rules
    ##############################

    - capability: THDM_spectrum
      function: get_THDM_spectrum

    # -------------------------------------------

    ##
    # the check_all_scales option-flag triggers evaluation
    # of the likelihood at the default Qin scale, 
    # but also at QrunTo scale, where the worst performing
    # of the two likelihoods is returned.
    # eg. min[L(Q_in), L(Q_runTo)]
    #

    - capability: perturbativity_likelihood_THDM
      function: get_perturbativity_likelihood_THDM
      options:
        check_all_scales: false

    - capability: stability_likelihood_THDM
      function: get_stability_likelihood_THDM
      options:
        check_all_scales: true

    - capability: NLO_unitarity_likelihood_THDM
      function: get_NLO_unitarity_likelihood_THDM
      options:
        check_all_scales: false
        check_correction_ratio: true

    # -------------------------------------------

    # Specifies effc coupling input for HB/HS
    - capability: HB_ModelParameters_neutral
      function: THDM_ModelParameters_effc
      module: ColliderBit

    - capability: HB_ModelParameters_charged
      function: THDM_ModelParameters_charged
      module: ColliderBit

    # -------------------------------------------

    - capability: SuperIso_modelinfo
      function: SI_fill
    
    - capability: b2sll_M
      function: b2sll_measurements

    - capability: Bsmumu_untag
      function: SI_Bsmumu_untag
      module: FlavBit

    - capability: bsgamma
      function: SI_bsgamma
      module: FlavBit

    # Choose to use gm2calc for g-2
    - capability: muon_gm2
      function: SI_muon_gm2

    # Choose to base the SM prediction for g-2 on e+e- data
    - capability: muon_gm2_SM
      function: gm2_SM_ee

    # Choose to use superiso for DeltaMBs calc
    - capability: DeltaMs
      function: SI_Delta_MBs

    # Choose to use superiso for RK calcs
    - capability: RK
      function: SI_RK

    - capability: RKstar_0045_11
      function: SI_RKstar_0045_11

    - capability: RKstar_11_60
      function: SI_RKstar_11_60

#########################
# Logging setup
#########################

Logger:

  redirection:
    [Debug] :  "Debug.log"
    [Default] :  "Default.log"
    [DecayBit] :  "DecayBit.log"
    [DarkBit] :  "DarkBit.log"
    [PrecisionBit] :  "PrecisionBit.log"
    [ColliderBit] :  "ColliderBit.log"
    [SpecBit] :  "SpecBit.log"
    [Dependency Resolver] :  "DepResolver.log"
    [Scanner]:  "Scanner.log"

##########################
# Name/Value Section
##########################

KeyValues:

  likelihood:
    model_invalid_for_lnlike_below: -1e6
    model_invalid_for_lnlike_below_alt: -5e5
    debug: false

  dependency_resolution:
    prefer_model_specific_functions: true
    use_old_routines: false

  #By default, errors are fatal and warnings non-fatal
  exceptions:
    dependency_resolver_error: fatal
    dependency_resolver_warning: non-fatal
    core_warning: fatal

  default_output_path: "runs/THDMIIatQ_nlo_unitarity_with_corrections/"
  debug: true