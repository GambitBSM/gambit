##########################################################################
## GAMBIT configuration for running a diver scan of the THDM
## THDM Type II (with running)
##
## Includes all compatible likelihoods:
## Theoretical, experimental & flavor
##
## Requires backends:
## THDMC, SuperISO, HiggsBounds, HiggsSignals
##########################################################################

Parameters:
  StandardModel_SLHA2: !import include/StandardModel_SLHA2_defaults.yaml

  THDMIIatQ:
      lambda_1:
          range: [-0.5, 12.5664]
          prior_type: flat
      lambda_2:
          range: [-0.5, 12.5664]
          prior_type: flat
      lambda_3:
          range: [-12.5664, 12.5664]
          prior_type: flat
      lambda_4:
          range: [-12.5664, 12.5664]
          prior_type: flat
      lambda_5:
          range: [-12.5664, 12.5664]
          prior_type: flat
      # --- Assuming a CP-conserving THDM model ---
      lambda_6:
          fixed_value: 0.0
      lambda_7:
          fixed_value: 0.0
      # -------------------------------------------
      m12_2:
          ranges: [-1e6, -1e4, 1e4, 1e7]
          prior_type: double_log_flat_join
      tanb:
          range: [0.1, 100]
          prior_type: log
      Qin:
          fixed_value: 91.1876 # = mZ
      QrunTo:
          fixed_value: 1000 # for comparison with other literature

##############################
# Printer setup
##############################

Printer:

  # Select printer to use via string tag
  printer: hdf5

  options:
    # name of output file
    output_file: "GAMBIT_THDMIIatQ_scan_output.hdf5"
    group: "/data"
    delete_file_on_restart: false


##############################
# Scanner setup
##############################

Scanner:
  use_scanner: de

  scanners:
    de:
      plugin: diver
      like: LogLike
      NP: 1000
      convthresh: 1e-5
      verbosity: 1

      # No options to set, but still need the nodes at the moment...
      aux_printer_txt_options:
      aux_printer_stats_options:
      aux_printer_live_options:

ObsLikes:

  ###########################
  # Likelihoods
  ###########################

  # Checks that loop corrections to the pole mass of mh0
  # do not exceed 50% of the input mass at Qin
  # Likelihood type: Acceptance/Rejection
  # - purpose:    LogLike
  #   capability: h0_loop_order_corrections
  #   function: check_h0_loop_order_corrections

  # # Checks that loop corrections to the pole masses of mH0,
  # # mA0, mHpm do not exceed 50% of the input mass at Qin
  # # Likelihood type: Acceptance/Rejection
  # - purpose:    LogLike
  #   capability: THDM_scalar_loop_order_corrections
  #   function: check_THDM_scalar_loop_order_corrections

  # # Calculates all quartic Higgs couplings in the physical
  # # basis & applies a 4pi perturbativity constraint on each
  # # Likelihood type: Half-Gaussian
  # - purpose:    LogLike
  #   capability: perturbativity_likelihood_THDM

  # # Applies the THDM stability constraints on the potential
  # # NOTE: This likelihood has two parts, described below
  # # (i) Applies strict stability constraint
  # # Likelihood type: Acceptance/Rejection
  # # (ii) If rejected, applies looser stabililty constraints
  # # Likelihood type: Half-Gaussian
  # - purpose:    LogLike
  #   capability: stability_likelihood_THDM

  # # Checks that the NLO scattering-matrix is unitary
  # # Calculates and applies limit on eigenvalues of matrix
  # # NOTE: This is always a subset of LO unitarity so it not needed
  # # Likelihood type: Half-Gaussian
  # # Only supports CP-conserving models
  # - purpose:    LogLike
  #   capability: NLO_unitarity_likelihood_THDM

  # # Calculates the electroweak precision parameters, S, T, U, V, W, X
  # # & fits to meausured values. S, T, U involve a correlation matrix.
  # # Includes low-energy notation described in arxiv::9407203.
  # # Likelihood type: Half-Gaussian
  # - purpose:    LogLike
  #   capability: oblique_parameters_likelihood_THDM

  # # -------------------------------------------

  - purpose:    LogLike
    capability: b2sgamma_LogLikelihood

  # - purpose:    LogLike
  #   capability: B2mumu_LogLikelihood_LHCb

  # - purpose:    LogLike
  #   capability: B2mumu_LogLikelihood_CMS

  # - purpose:    LogLike
  #   capability: B2mumu_LogLikelihood_Atlas
   
  # # Semi-Leptonic likelihood collection
  - capability: SL_LL
    function: SL_likelihood
    purpose: LogLike

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_0p1_0p98_LHCb

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_1p1_2p5_LHCb

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_2p5_4_LHCb

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_4_6_LHCb

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_6_8_LHCb

  # - purpose:    Observable
  #   capability: prediction_B2KstarmumuAng_15_19_LHCb

  - purpose:    LogLike
    capability: B2KstarmumuAng_LogLikelihood_Atlas

  - purpose:    LogLike
    capability: B2KstarmumuAng_LogLikelihood_CMS

  - purpose:    LogLike
    capability: B2KstarmumuAng_LogLikelihood_Belle

  # - purpose:    LogLike
  #   capability: B2KstarmumuAng_LogLikelihood_LHCb_2020

  - purpose:    LogLike
    capability: B2KstarmumuBr_LogLikelihood_LHCb

  - purpose:    LogLike
    capability: Bs2phimumuBr_LogLikelihood

  - purpose:    LogLike
    capability: B2KmumuBr_LogLikelihood_LHCb

  # Bs0 and Bd0 Meson Mass Splitting added to FlavBit
  # Necessary calculations added to superiso via patch supplied by Nazila
  - capability: deltaMB_LL
    function: deltaMB_likelihood
    purpose: LogLike

  - capability: deltaMBd_LL
    function: deltaMBd_likelihood
    purpose: LogLike
  # -------------------------------------------

  ### NOTE
  # LHC & LEP likelihoods
  # Coupling Squared input structs are filled by colliderBit,
  # then chi^2 are extracted directly from HS & HB

  # HB 5beta likelihood
  - capability: LEP_Higgs_LogLike
    function: calc_HB_5_LEP_LogLike
    purpose: LogLike
    dependencies:
      - capability: HB_ModelParameters_neutral
        function: THDM_ModelParameters_effc
        module: ColliderBit
      - capability: HB_ModelParameters_charged
        function: THDM_ModelParameters_charged
        module: ColliderBit

  # HS 2beta likelihood
  - capability: LHC_Higgs_LogLike
    function: calc_HS_2_LHC_LogLike
    purpose: LogLike
    dependencies:
      - capability: HB_ModelParameters_neutral
        function: THDM_ModelParameters_effc
        module: ColliderBit
      - capability: HB_ModelParameters_charged
        function: THDM_ModelParameters_charged
        module: ColliderBit

  #################
  # Observables
  #################

  # spectrum observables

  - capability: mh0_pole
    function: obs_mh0_pole
    purpose: Observable

  - capability: mh0_running
    function: obs_mh0_running
    purpose: Observable

  - capability: mH0_pole
    function: obs_mH0_pole
    purpose: Observable

  - capability: mH0_running
    function: obs_mH0_running
    purpose: Observable

  - capability: mA0_pole
    function: obs_mA0_pole
    purpose: Observable

  - capability: mA0_running
    function: obs_mA0_running
    purpose: Observable

  - capability: mHpm_pole
    function: obs_mHpm_pole
    purpose: Observable

  - capability: mHpm_running
    function: obs_mHpm_running
    purpose: Observable

  - capability: lambda_1
    function: obs_lambda_1
    purpose: Observable

  - capability: lambda_2
    function: obs_lambda_2
    purpose: Observable

  - capability: lambda_3
    function: obs_lambda_3
    purpose: Observable

  - capability: lambda_4
    function: obs_lambda_4
    purpose: Observable

  - capability: lambda_5
    function: obs_lambda_5
    purpose: Observable

  - capability: lambda_6
    function: obs_lambda_6
    purpose: Observable

  - capability: lambda_7
    function: obs_lambda_7
    purpose: Observable

  - capability: m12_2
    function: obs_m12_2
    purpose: Observable

  - capability: m11_2
    function: obs_m11_2
    purpose: Observable

  - capability: m22_2
    function: obs_m22_2
    purpose: Observable

  - capability: tanb
    function: obs_tanb
    purpose: Observable

  - capability: alpha
    function: obs_alpha
    purpose: Observable

  - capability: sba
    function: obs_sba
    purpose: Observable

  - capability: cba
    function: obs_cba
    purpose: Observable

  # interesting flavour observables

  # - capability: bsgamma
  #   function: SI_bsgamma
  #   purpose: Observable

  - capability: DeltaMs
    function: SI_Delta_MBs
    purpose: Observable

  - capability: all_BFs
    function: get_decaytable_as_map
    options:
      # Opt 1: choose to print every single branching fraction
      printall: true 
      # Opt 2: choose which particles to print BFs for
      #BFs: [ ["h0_1"], ["t"] ]
      # Opt 3: choose which specific channels to printd BFs for
      #BFs: [ ["h0_1", "V", "V"],
      #       ["h0_1", "b", "bbar"] ]

  # Checks if the vacuum leads to a global minimum solution
  # Returns 0 if it is metastable or unstable (otherwise 1)
  # Only supports CP-conserving models

  - capability: vacuum_global_minimum
    function: check_vacuum_global_minimum
    purpose: Observable  
  
    
Rules:

  ##############################
  # Likelihood/Observable Rules
  ##############################

  - capability: THDM_spectrum
    function: get_THDM_spectrum

  - capability: decay_rates
    function: all_decays
    module: DecayBit

  # the check_all_scales option-flag triggers evaluation
  # of the likelihood at the default Qin scale, 
  # but also at QrunTo scale, where the worst performing
  # of the two likelihoods is returned.
  # eg. min[L(Q_in), L(Q_runTo)]
  - capability: perturbativity_likelihood_THDM
    function: get_perturbativity_likelihood_THDM
    options:
      check_all_scales: true
      simple_perturbativity: false

  - capability: stability_likelihood_THDM
    function: get_stability_likelihood_THDM
    options:
      check_all_scales: true

  - capability: NLO_unitarity_likelihood_THDM
    function: get_NLO_unitarity_likelihood_THDM
    options:
      check_correction_ratio: true

  # Specifies effc coupling input for HB/HS
  - capability: HB_ModelParameters_neutral
    function: THDM_ModelParameters_effc
    module: ColliderBit

  - capability: HB_ModelParameters_charged
    function: THDM_ModelParameters_charged
    module: ColliderBit

    # B2mumu

  - capability: prediction_B2mumu
    options:
      obs_list: [BRuntag_Bsmumu, BR_Bdmumu]

  - capability: B2mumu_LogLikelihood_LHCb
    function: HEPLike_B2mumu_LogLikelihood_LHCb
    options:
      obs_list: [BRuntag_Bsmumu, BR_Bdmumu]

  - capability: B2mumu_LogLikelihood_CMS
    function: HEPLike_B2mumu_LogLikelihood_CMS
    options:
      obs_list: [BRuntag_Bsmumu, BR_Bdmumu]
    
  - capability: B2mumu_LogLikelihood_Atlas
    function: HEPLike_B2mumu_LogLikelihood_Atlas
    options:
      obs_list: [BRuntag_Bsmumu, BR_Bdmumu]

      # B2kstarmumu ATLAS

  - capability: prediction_B2KstarmumuAng_0p1_2_Atlas
    options:
      obs_list: [FL, S3, S4, S5, S7, S8]

  - capability: prediction_B2KstarmumuAng_2_4_Atlas
    options:
      obs_list: [FL, S3, S4, S5, S7, S8]

  - capability: prediction_B2KstarmumuAng_4_8_Atlas
    options:
      obs_list: [FL, S3, S4, S5, S7, S8]
  
  - capability: B2KstarmumuAng_LogLikelihood_Atlas
    options:
      obs_list: [FL, S3, S4, S5, S7, S8]


      # B2kstarmumu BELLE

  - capability: prediction_B2KstarmumuAng_0p1_4_Belle
    options:
      obs_list: [P4prime, P5prime]

  - capability: prediction_B2KstarmumuAng_4_8_Belle
    options:
      obs_list: [P4prime, P5prime]

  - capability: prediction_B2KstarmumuAng_10p9_12p9_Belle
    options:
      obs_list: [P4prime, P5prime]
  
  - capability: prediction_B2KstarmumuAng_14p18_19_Belle
    options:
      obs_list: [P4prime, P5prime]

  - capability: B2KstarmumuAng_LogLikelihood_Belle
    options:
      obs_list: [P4prime, P5prime]

    # B2kstarmumu LHCB2020

  # - capability: B2KstarmumuAng_LogLikelihood_LHCb_2020
  #   function: HEPLike_B2KstarmumuAng_LogLikelihood_LHCb_2020
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]  

  # - capability: prediction_B2KstarmumuAng_0p1_0p98_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

  # - capability: prediction_B2KstarmumuAng_1p1_2p5_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

  # - capability: prediction_B2KstarmumuAng_2p5_4_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

  # - capability: prediction_B2KstarmumuAng_4_6_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

  # - capability: prediction_B2KstarmumuAng_6_8_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

  # - capability: prediction_B2KstarmumuAng_15_19_LHCb
  #   options:
  #     obs_list: [FL, AFB, S3, S4, S5, S7, S8, S9]

    
    # B2kstarmumu CMS 
  
  - capability: prediction_B2KstarmumuAng_1_2_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_2_4p3_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_4p3_6_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_6_8p68_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_10p09_12p86_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_14p18_16_CMS
    options:
      obs_list: [P1, P5prime]

  - capability: prediction_B2KstarmumuAng_16_19_CMS
    options:
      obs_list: [P1, P5prime]
      
  - capability: B2KstarmumuAng_LogLikelihood_CMS
    options:
      obs_list: [P1, P5prime]

  # Use SM theory covariance matrix for every point
  - capability: SuperIso_theory_covariance
    function: SI_theory_covariance

  # Use SuperIso instead of FeynHiggs for b->sgamma
  - capability: bsgamma
    function: SI_bsgamma

  # Use SuperIso instead of FeynHiggs for B_s->mumu
  - capability: Bsmumu_untag
    function: SI_Bsmumu_untag

  # Use SuperIso instead of FeynHiggs for B_s->mumu
  - capability: Btaunu
    function: SI_Btaunu

  # # Choose superiso for Flavour physics calculations
  - capability: SuperIso_modelinfo
    function: SI_fill
  
  # - capability: Bsmumu_untag
  #   function: SI_Bsmumu_untag
  #   module: FlavBit

  # - capability: bsgamma
  #   function: SI_bsgamma
  #   module: FlavBit

  - capability: DeltaMs
    function: SI_Delta_MBs

#########################
# Logging setup
#########################

Logger:

redirection:
  [Debug] :  "stderr"
  [Default] :  "stderr"
  [DecayBit] :  "stderr"
  [DarkBit] :  "stderr"
  [PrecisionBit] :  "stderr"
  [ColliderBit] :  "stderr"
  [SpecBit] :  "stderr"
  [Dependency Resolver] :  "stderr"
  [Scanner]:  "stderr"

##########################
# Name/Value Section
##########################

KeyValues:

  likelihood:
    model_invalid_for_lnlike_below: -1e8
    model_invalid_for_lnlike_below_alt: -5e7
    debug: false
    
  default_output_path: "runs/THDMIatQ_b2sgam/"
  debug: true